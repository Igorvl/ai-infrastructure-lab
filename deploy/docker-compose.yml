services:
  llm-router:
    build:
      context: ..
      dockerfile: deploy/Dockerfile.router
      args:
        HTTP_PROXY: "http://172.17.0.1:10809"
        HTTPS_PROXY: "http://172.17.0.1:10809"
    container_name: ai-router
    restart: unless-stopped
    ports:
      - "8000:8000"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - ENV_TYPE=production
      - CONFIG_PATH=deploy/antigravity.json
      # Настройки прокси для работы внутри контейнера (Runtime)
      - http_proxy=http://host.docker.internal:10808
      - https_proxy=http://host.docker.internal:10808
      - all_proxy=http://host.docker.internal:10808
      - HTTP_PROXY=http://host.docker.internal:10808
      - HTTPS_PROXY=http://host.docker.internal:10808
      - ALL_PROXY=http://host.docker.internal:10808
      # --- ПРЯМОЙ ДОСТУП ДЛЯ КИТАЯ (БЕЗ ПРОКСИ) ---
      - no_proxy=api.siliconflow.com,localhost,127.0.0.1
      - NO_PROXY=api.siliconflow.com,localhost,127.0.0.1
      - no_proxy=dashscope.aliyuncs.com,open.bigmodel.cn
      - NO_PROXY=dashscope.aliyuncs.com,open.bigmodel.cn
      # --------------------------------------------
      # Добавим дебаг, если что
      - LITELLM_LOG=DEBUG
      # Ключи API
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - SILICONFLOW_API_KEY=${SILICONFLOW_API_KEY}
      # - ALIBABA_API_KEY=${ALIBABA_API_KEY}
      # - GLM_API_KEY=${GLM_API_KEY}
      # - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
    volumes:
      - ../routing/logs:/app/logs
    networks:
      - ai-net
    depends_on:
      - qdrant
      - postgres

  qdrant:
    image: qdrant/qdrant:latest
    container_name: ai-qdrant
    restart: always
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - ai-net

  minio:
    image: minio/minio
    container_name: ai-minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD}
    volumes:
      - minio_data:/data
    networks:
      - ai-net

  postgres:
    image: postgres:15-alpine
    container_name: ai-postgres
    restart: always
    environment:
      POSTGRES_USER: ${PG_USER}
      POSTGRES_PASSWORD: ${PG_PASSWORD}
      POSTGRES_DB: ai_metadata
    volumes:
      - pg_data:/var/lib/postgresql/data
    networks:
      - ai-net

  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: ai-webui
    restart: always
    ports:
      - "3000:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      - OPENAI_API_BASE_URL=http://ai-router:8000/v1
      - OPENAI_API_KEY=sk-mock-key
    volumes:
      - webui_data:/app/backend/data
    networks:
      - ai-net
    depends_on:
      - llm-router

networks:
  ai-net:
    driver: bridge

volumes:
  qdrant_data:
  minio_data:
  pg_data:
  webui_data:
