services:
  # --- Layer 1: Routing Gateway (Our Custom Brain) ---
  llm-router:
    build:
      context: ..
      dockerfile: deploy/Dockerfile.router
    container_name: ai-router
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - ENV_TYPE=production
      - CONFIG_PATH=deploy/antigravity.json
      # Секреты берем из .env (никогда не хардкодим!)
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GLM_API_KEY=${GLM_API_KEY}
    volumes:
      - ../routing/logs:/app/logs
    networks:
      - ai-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # --- Layer 2: Data Storage ---
  qdrant:
    image: qdrant/qdrant:latest
    container_name: ai-qdrant
    restart: always
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - ai-net

  minio:
    image: minio/minio
    container_name: ai-minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD}
    volumes:
      - minio_data:/data
    networks:
      - ai-net

  postgres:
    image: postgres:15-alpine
    container_name: ai-postgres
    restart: always
    environment:
      POSTGRES_USER: ${PG_USER}
      POSTGRES_PASSWORD: ${PG_PASSWORD}
      POSTGRES_DB: ai_metadata
    volumes:
      - pg_data:/var/lib/postgresql/data
    networks:
      - ai-net

  # --- Layer 3: Frontend ---
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: ai-webui
    restart: always
    ports:
      - "3000:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - OLLAMA_BASE_URL=http://host.docker.internal:11434 # Если локальный Ollama
      - OPENAI_API_BASE_URL=http://ai-router:8000/v1 # Указываем на НАШ роутер
      - OPENAI_API_KEY=sk-mock-key # Роутер примет любой ключ или проверит свой
    volumes:
      - webui_data:/app/backend/data
    networks:
      - ai-net
    depends_on:
      - llm-router

networks:
  ai-net:
    driver: bridge

volumes:
  qdrant_data:
  minio_data:
  pg_data:
  webui_data:
